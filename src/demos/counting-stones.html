<html>
    <head>
        <title>DEMO</title>
    </head>
    <body>
        <canvas id=c width=640 height=480 />

        <script type="text/javascript" src="../yepnope.1.0.2-min.js"></script>
        <script type="text/javascript" src="../playnow/playnow.js"></script>
        <script type="text/javascript">
            var viewport, scene;

            now.onload(function(){
                function MouseMap() {
                    this.__mousemap_targets = [];
                    this.__mousemap_lock = null;
                }
                MouseMap.prototype = new Entity();
                MouseMap.prototype.addTarget = function(target) {
                    this.__mousemap_targets.push(target);
                    target.bind('setposition', function(e, pos) {
                        var bounds = target.get('mousebounds');
                        target.set('mousebounds', new R(pos.x, pos.y, bounds.w, bounds.h));
                    });
                };
                MouseMap.prototype.onmouse = function(e, event_pos) {
                    var self = this
                    ,   i = 0
                    ,   l = this.__mousemap_targets.length
                    ,   targets = this.__mousemap_targets
                    ,   entity
                    ,   entity_pos
                    ,   args = arguments;
                    ;

                    function mouselock(entity) {
                        entity.trigger('mouse.lock.acquire');
                        self.__mousemap_lock = entity;
                    }
                    function mouserelease(entity) {
                        if (!!entity && entity === self.__mousemap_lock) {
                            entity.trigger('mouse.lock.release');
                            self.__mousemap_lock = null;
                        }
                    }

                    e.mouselock = mouselock;
                    e.mouserelease = mouserelease;

                    if (this.__mousemap_lock !== null) {
                        entity = this.__mousemap_lock;
                        if (try_target.call(this, entity)) {
                            return;
                        }
                    }
                    for (i=0;i < l; i+=1) {
                        entity = targets[i];
                        if (try_target.call(this, entity)) {
                            break;
                        }
                    }
                    if (i === l) {
                        e.mouserelease(this.__mousemap_lock);
                    }
                    delete e.mouselock;
                    delete e.mouserelease;

                    function try_target(entity) {
                        var e, entity_pos;
                        entity_pos = entity.get('mousebounds');
                        if (entity_pos.intersects(event_pos)) {
                            e = entity.trigger.apply(entity, args);
                            if (!e.mousemissed) {
                                return true;
                            }
                        }
                        return false;
                    }
                };

                var Smiley = now.type('Smiley', {
                    inherit: Entity,
                    init: function() {
                        Entity.apply(this, arguments);

                        this.dragging = false;

                        this.bind('mouse.drag', function(e, pos, lastpos) {
                            var curpos = this.get('position')
                            ,   offset = lastpos.subtract(pos)
                            ,   relpos = pos.subtract(curpos)
                            ,   img = this.get('imagectx')
                            ,   imgdata = img.getImageData(relpos.x, relpos.y, 1, 1)
                            ,   empty = imgdata.data[3] === 0;
                            ;
                            
                            this.dragging = true;

                            if (empty) {
                                e.mousemissed = true;
                                e.mouserelease(this);
                            } else {
                                this.set('position', curpos.subtract(offset));
                                e.mouselock(this);
                            }
                        });
                        this.bind('mouse.up', function(e) {
                            e.mouserelease(this);
                        });
                    },
                    'onmouse.lock.release': function(e) {
                        if (this.dragging) {
                            arguments[0] = 'mouse.drop';
                            this.trigger.apply(this, arguments);
                        }
                    },
                    'onmouse.drop': function(e) {
                        console.log("I was dropped!");
                    }
                });

                function MenuScene() {
                    var i, entity, mousemap, position;

                    this.set('clearEachFrame', [1, 1, 0.7, 1]);

                    mousemap = new MouseMap();
                    this.set('mousemap', mousemap);
                    this.propagate('mouse', 'mousemap');

                    for (i=0; i<10; i+=1) {
                        position = new V(Math.random() * 640, Math.random() * 480)
                        entity = new Smiley({
                            position: position
                        ,   mousebounds: new R(position.x, position.y, 100, 100)
                        ,   image: "/src/smiley.png"
                        });
                        mousemap.addTarget(entity);
                        this.add(entity);
                    }
                }
                MenuScene.prototype = new Scene();

                viewport = new ViewPort('c');
                scene = new MenuScene();
                viewport.set('scene', scene);
            });
        </script>
    </body>
</html>
